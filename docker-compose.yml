services:
  signal-api:
    image: bbernhard/signal-cli-rest-api:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ~/.local/share/signal-cli:/home/.local/share/signal-cli
    environment:
      - MODE=json-rpc

  penny:
    build:
      context: ./penny
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_COMMIT_MESSAGE: ${GIT_COMMIT_MESSAGE:-unknown}
    image: penny
    restart: unless-stopped
    volumes:
      - ./data:/penny/data
      - ./.env:/penny/.env
      - ./github_api:/shared/github_api:ro
    environment:
      - PYTHONUNBUFFERED=1
      - SIGNAL_API_URL=http://signal-api:8080
      - LOG_FILE=/penny/data/penny.log

  pm:
    build:
      context: .
      dockerfile: penny-team/Dockerfile
    restart: unless-stopped
    profiles: [team]
    command: ["--agent", "product-manager"]
    volumes:
      - ./data:/repo/data
      - ./github_api:/shared/github_api:ro
    env_file: .env
    environment:
      - PYTHONUNBUFFERED=1
      - LOCAL=1

  architect:
    build:
      context: .
      dockerfile: penny-team/Dockerfile
    restart: unless-stopped
    profiles: [team]
    command: ["--agent", "architect"]
    volumes:
      - ./data:/repo/data
      - ./github_api:/shared/github_api:ro
    env_file: .env
    environment:
      - PYTHONUNBUFFERED=1
      - LOCAL=1

  worker:
    build:
      context: .
      dockerfile: penny-team/Dockerfile
    restart: unless-stopped
    profiles: [team]
    stop_grace_period: 120s
    command: ["--agent", "worker"]
    volumes:
      - ./data:/repo/data
      - ./github_api:/shared/github_api:ro
    env_file: .env
    environment:
      - PYTHONUNBUFFERED=1
      - LOCAL=1

  monitor:
    build:
      context: .
      dockerfile: penny-team/Dockerfile
    restart: unless-stopped
    profiles: [team]
    command: ["--agent", "monitor"]
    volumes:
      - ./data:/repo/data
      - ./github_api:/shared/github_api:ro
    env_file: .env
    environment:
      - PYTHONUNBUFFERED=1
      - LOCAL=1

  quality:
    build:
      context: .
      dockerfile: penny-team/Dockerfile
    restart: unless-stopped
    profiles: [team]
    command: ["--agent", "quality"]
    volumes:
      - ./data:/repo/data
      - ./github_api:/shared/github_api:ro
    env_file: .env
    environment:
      - PYTHONUNBUFFERED=1
      - LOCAL=1

  watcher:
    build: ./scripts/watcher
    restart: unless-stopped
    profiles: [team]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/repo
    environment:
      - DEPLOY_INTERVAL=300
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME:-penny}
      - HOST_PROJECT_DIR=${PWD}
    working_dir: /repo
